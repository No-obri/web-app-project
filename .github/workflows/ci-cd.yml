name: Node.js CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x, 22.x, 24.x]   # Updated to current/relevant versions in 2026 (20 EOL soon, 22 maintenance, 24 active LTS)

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4   # Updated from v2

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4   # Updated from v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'   # Caches node_modules for faster runs

      - name: Install Dependencies
        run: npm ci   # Prefer npm ci over npm install for CI (clean & reproducible)

      - name: Run Tests
        run: npm test   # Assumes you have a "test" script in package.json

      - name: Notify on Failure
        if: failure()
        run: echo "Workflow Failed - Check logs for details"

  deploy:
    runs-on: ubuntu-latest
    needs: build   # Only run if build (including matrix) succeeds
    if: github.ref == 'refs/heads/main'   # Only deploy on pushes to main (not PRs)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x   # Use latest active LTS for deployment

      - name: Install Dependencies
        run: npm ci

      - name: Deploy to Production
        run: |
          echo "Deploying to production server..."
          # Replace the echo with your real deployment command, examples:
          # vercel --prod --token ${{ secrets.VERCEL_TOKEN }}
          # npm run deploy
          # rsync ... or aws cli, gcloud, etc.
        env:
          API_KEY: ${{ secrets.PRODUCTION_API_KEY }}   # Example secret usage
          # Add more env vars as needed, e.g.:
          # DATABASE_URL: ${{ secrets.DATABASE_URL }}
